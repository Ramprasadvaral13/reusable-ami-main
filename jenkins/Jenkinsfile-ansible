pipeline {
    agent any

    environment {
        WORKSPACE = 'ansible-project'
        AWS_PROFILE = 'pro'
        AWS_REGION = 'us-east-1'
        INVENTORY_PATH = "${WORKSPACE}/inventory/aws_ec2.yml"
        PATCH_PLAYBOOK = "${WORKSPACE}/patch.yml"
        DOCKER_PLAYBOOK = "${WORKSPACE}/docker.yml"
    }

    stages {
        stage('Validate AWS Auth/Profile') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "aws sts get-caller-identity --profile ${env.AWS_PROFILE}"
                }
            }
        }

        stage('Check Ansible Inventory') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-inventory -i ${env.INVENTORY_PATH} --graph"
                }
            }
        }

        stage('Run Patch Playbook') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-playbook -i ${env.INVENTORY_PATH} ${env.PATCH_PLAYBOOK} -vvv"
                }
            }
        }

        stage('Run Docker Installation') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-playbook -i ${env.INVENTORY_PATH} ${env.DOCKER_PLAYBOOK} -vvv"
                }
            }
        }

        stage('Verify Docker Installation') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible -i ${env.INVENTORY_PATH} env__dev -m command -a 'docker --version' -b"
                }
            }
        }
    }

    post {
        success {
            echo 'Jenkins pipeline completed successfully.'
        }
        failure {
            echo 'Pipeline failed. Please check the logs.'
        }
        always {
            dir("${env.WORKSPACE}") {
                archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
            }
        }
    }
}

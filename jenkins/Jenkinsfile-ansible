pipeline {
    agent any
    environment {
        WORKSPACE = 'ansible-project'
        AWS_PROFILE = 'pro'
        AWS_REGION = 'us-east-1'
        INVENTORY_PATH = "${WORKSPACE}/inventory/aws_ec2.yml"
        PATCH_PLAYBOOK = "${WORKSPACE}/patch.yml"
        DOCKER_PLAYBOOK = "${WORKSPACE}/docker.yml"
    }
    stages {
        stage('Validate AWS Authentication') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "aws sts get-caller-identity --profile ${env.AWS_PROFILE}"
                }
            }
        }
        stage('Check Ansible Inventory') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-inventory -i inventory/aws_ec2.yml --graph"
                }
            }
        }
        stage('Run Patch Playbook') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-playbook -i inventory/aws_ec2.yml patch.yml -vvv"
                }
            }
        }
        stage('Run Docker Installation') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible-playbook -i inventory/aws_ec2.yml docker.yml -vvv"
                }
            }
        }
        stage('Verify Docker Installation') {
            steps {
                dir("${env.WORKSPACE}") {
                    sh "ansible -i inventory/aws_ec2.yml env__dev -m command -a 'docker --version' -b"
                }
            }
        }
    }
    post {
        success {
            echo 'Pipeline completed successfully'
        }
        failure {
            echo 'Pipeline failed, check logs'
        }
        always {
            dir("${env.WORKSPACE}") {
                archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
            }
        }
    }
}
